## 7.4.4 使客户端实现跨域通信 -JSONP-
&emsp;&emsp;正如之前所说的，在Ajax（或者说是XMLHttpRequest对象）中，因为安全性等理由，限制了跨源通信。也就是说在原则上，JavaScript的代码不可以直接和不同网站上提供的服务进行通信。<br>
&emsp;&emsp;因此，在同一个域的服务器中架设用来访问外部服务的应用（代理），采取「客户端通过代理来访问外部服务」这样的方法。这个是之前介绍的例子。
##### 【404页】
![image](../../images/c7/スクリーンショット&#32;2019-04-16&#32;午前10.40.05.png)
> 同一个域  
> PHP等  
> proxy（代理）  
> ①调用服务器端的代码  
> 客户端  
> ②在服务器端执行外部服务  
> 不同的域  
> 不能访问不同的域

**●访问外部的服务（通过代理）**

&emsp;&emsp;但是，只是访问外部的服务就要准备服务器端的代码会很麻烦。因此，这里我们考虑JSONP（JSON with Padding）。JSONP一句话来说就是利用

如果是`<script>`元素就可以读取外部服务器的脚本

的结构。虽然有各种绕过跨源的方法，而JSONP也是这些经典的方法之一。
![image](../../images/c7/スクリーンショット&#32;2019-04-16&#32;午前10.48.52.png)
> PHP等  
> 不需要代理  
> 如果是`<script>`元素，则可以跨域通信  
> 客户端  
> 点击按钮  
> ①触发事件时，生成下载外部脚本的`<script>`元素  
> ……处理结果的代码……  
> 不同的域  
> ②通过`<script>`元素执行外部服务  
> 返回值  
> 返回值是「回调函数名(JSON数据)」的JavaScript代码  
> ③根据返回值（函数调用的代码）调用客户端的函数

**●JSONP（JSON with Padding）**
##### 【405页】
&emsp;&emsp;在JSONP中，在触发按钮点击等事件时，生成用来包含外部服务器的脚本的`<script>`元素。然后，外部服务器通过`<script>`元素向客户端响应JSON数据中包含的函数调用代码。<br>
&emsp;&emsp;之后，根据外部服务器的指示在客户端准备需要调用的函数（处理JSON数据的函数），就可以处理外部服务器发送的JSON数据了。<br>
&emsp;&emsp;「通过在外部服务器生成的脚本来调用客户端的函数」和目前为止介绍的方法相反，所以可能有些难以理解。请配合上一页的图解来理解处理流程。

**■实现「Hatena书签检索功能」（JSONP版）**<br>
&emsp;&emsp;介绍了很大篇幅概念，现在我们来看下具体的实现示例吧。我们将清单7-25～7-26中实现的书签检索功能使用JSONP来实现。

**（1）查看HatenaAPI的动作**<br>
&emsp;&emsp;要支持JSONP，需要给HatenaAPI传递以下的参数。

- url → 想要获取书签个数的URL
- callback → 之后调用的JavaScript函数的名称

&emsp;&emsp;url参数在之前的例子中也传递了。JSONP中新增的是callback参数。这样，结果数据就可以调用函数并将结果括起来。<br>
&emsp;&emsp;下面，是查询URL的例子及其结果。
![image](../../images/c7/スクリーンショット&#32;2019-04-17&#32;午前9.44.57.png)
&emsp;&emsp;在客户端中，使用`<script>`元素将其导入，并将JSON数据传递给事先准备好的回调函数（在这里是show）。

**（2）创建客户端页面**<br>
&emsp;&emsp;记住上面的内容，接着我们创建客户端的代码。
##### 【406页】
**●清单7-27 jsonp.html（上）／jsonp.js（下）**
![image](../../images/c7/スクリーンショット&#32;2019-04-17&#32;午前9.54.08.png)
> "检索"  
> // 生成查询服务的URL  
> // 生成用来接收来自服务的JavaScript代码的`<script>`元素  
> '没有找到书签。'  
> ……中间省略（参考P.403）……

&emsp;&emsp;show函数只是根据获取的JSON数据组合`<ul>`列表，和清单7-26是相同的。这里需要注意的是①的代码。<br>
&emsp;&emsp;在①中，为了导入查询服务的结果（JavaScript的代码），生成下面这样的`<script>`元素。
![image](../../images/c7/スクリーンショット&#32;2019-04-17&#32;午前10.00.20.png)
&emsp;&emsp;正如之前所说的，HatenaAPI会根据查询信息中callback设定的函数名和书签检索地址返回「show({...})」这样的JavaScript代码。<br>
&emsp;&emsp;也就是说，「点击按钮时嵌入`<script>`元素」相当于「点击按钮时调用show函数」。这样就可以具体地理解P.406的图中展示的JSONP的概念了。

&emsp;&emsp;虽然「通过`<script>`元素调用回调函数」的流程有一些特殊性，但是不需要服务器端的代理，所以应用开发一下子简单了很多。因为JSONP需要服务的支持，所以并不是所有的服务都支持的。在正确的地方使用JSONP，可以更简单地使用外部服务。

##### 【407页】
**Note XMLHttpRequest对象的跨源通信**<br>
&emsp;&emsp;虽然之前说「XMLHttpRequest对象不可以跨源通信」，但正确来说是最新的XMLHttpRequest对象支持跨源通信。但是，需要将服务在Access-Control-Allow-Origin响应头中显式地声明为允许。<br>
&emsp;&emsp;例如如果是PHP，如下。
![image](../../images/c7/スクリーンショット&#32;2019-04-17&#32;午前10.50.02.png)
&emsp;&emsp;这样，就可以访问「http://www.examples.com 」了。如果想要允许访问所有的域，请将粗体字部分改为「*」。<br>
&emsp;&emsp;另外，只有Internet Explorer 10之后版本的IE浏览器才支持XMLHttpRequest对象的跨源。